<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <!-- –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è CSP –¥–ª—è Firebase -->
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-eval' 'unsafe-inline' https://www.gstatic.com https://www.claudeusercontent.com https://cdnjs.cloudflare.com https://cdn.jsdelivr.net/pyodide/; connect-src 'self' https://*.firebaseio.com https://*.firebasedatabase.app wss://*.firebaseio.com https://*.googleapis.com; object-src 'none';">
    <title>–û–Ω–ª–∞–π–Ω –ö–≤–∏–∑</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 90%;
            text-align: center;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
        }

        input, select, button {
            padding: 15px 20px;
            margin: 10px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s ease;
        }

        input, select {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid transparent;
        }

        input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        input:focus, select:focus {
            border-color: #4ecdc4;
            background: rgba(255, 255, 255, 0.3);
        }

        button {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            cursor: pointer;
            font-weight: bold;
            min-width: 150px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .lobby-code {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 1.2em;
            letter-spacing: 3px;
        }

        .players-list {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .player {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .question-container {
            margin: 30px 0;
        }

        .question {
            font-size: 1.3em;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
        }

        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .option {
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid transparent;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: #4ecdc4;
        }

        .option.selected {
            background: #4ecdc4;
            border-color: #4ecdc4;
        }

        .results {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
        }

        .medal {
            font-size: 1.5em;
            margin-right: 10px;
        }

        .progress {
            background: rgba(255, 255, 255, 0.2);
            height: 10px;
            border-radius: 5px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress-bar {
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
            height: 100%;
            transition: width 0.3s ease;
        }

        .flag-emoji {
            font-size: 4em;
            margin: 20px 0;
        }

        .error {
            color: #ff6b6b;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 107, 107, 0.2);
            border-radius: 5px;
        }

        .success {
            color: #4ecdc4;
            margin: 10px 0;
            padding: 10px;
            background: rgba(78, 205, 196, 0.2);
            border-radius: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 20px;
            }
            
            .options {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="main-screen" class="screen active">
            <h1>üéØ –û–Ω–ª–∞–π–Ω –ö–≤–∏–∑</h1>
            <input type="text" id="player-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" maxlength="20">
            <div id="name-error" class="error" style="display: none;"></div>
            <div>
                <button id="create-lobby-btn">–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</button>
                <button id="join-lobby-btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            </div>
        </div>

        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–±–±–∏ -->
        <div id="create-lobby-screen" class="screen">
            <h2>–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</h2>
            <select id="theme-select">
                <option value="flags">üè≥Ô∏è –§–ª–∞–≥–∏ —Å—Ç—Ä–∞–Ω</option>
                <option value="minecraft">‚õèÔ∏è Minecraft</option>
            </select>
            <div>
                <button id="create-lobby-submit-btn">–°–æ–∑–¥–∞—Ç—å</button>
                <button id="back-to-main-btn">–ù–∞–∑–∞–¥</button>
            </div>
            <div id="create-error" class="error" style="display: none;"></div>
        </div>

        <!-- –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –ª–æ–±–±–∏ -->
        <div id="join-lobby-screen" class="screen">
            <h2>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ª–æ–±–±–∏</h2>
            <input type="text" id="lobby-code-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ª–æ–±–±–∏" maxlength="6">
            <div>
                <button id="join-lobby-submit-btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
                <button id="back-to-main-from-join-btn">–ù–∞–∑–∞–¥</button>
            </div>
            <div id="join-error" class="error" style="display: none;"></div>
        </div>

        <!-- –õ–æ–±–±–∏ -->
        <div id="lobby-screen" class="screen">
            <h2>–õ–æ–±–±–∏</h2>
            <div class="lobby-code">
                <div>–ö–æ–¥ –ª–æ–±–±–∏:</div>
                <div id="current-lobby-code"></div>
            </div>
            <div class="success">
                <div>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –∫–æ–¥–æ–º —Å –¥—Ä—É–∑—å—è–º–∏!</div>
            </div>
            <div class="players-list">
                <h3>–ò–≥—Ä–æ–∫–∏:</h3>
                <div id="players-container"></div>
            </div>
            <div id="host-controls" style="display: none;">
                <button id="start-game-btn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
            </div>
            <button id="leave-lobby-btn">–ü–æ–∫–∏–Ω—É—Ç—å –ª–æ–±–±–∏</button>
            <div id="lobby-error" class="error" style="display: none;"></div>
        </div>

        <!-- –ò–≥—Ä–∞ -->
        <div id="game-screen" class="screen">
            <div class="progress">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            <div id="question-counter"></div>
            <div class="question-container">
                <div id="question-flag" class="flag-emoji"></div>
                <div id="question-text" class="question"></div>
                <div id="options-container" class="options"></div>
            </div>
            <button id="next-question-btn" style="display: none;">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
            <button id="finish-game-btn" style="display: none;">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div id="results-screen" class="screen">
            <h2>üèÜ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
            <div id="results-container" class="results"></div>
            <button id="new-game-btn">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase (–æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏)
            const firebaseConfig = {
                apiKey: "AIzaSyAMBSvRY63cyjvQdbovfsSUws0r65iJ9vo",
                authDomain: "onlinequiz-bb97e.firebaseapp.com",
                databaseURL: "https://onlinequiz-bb97e-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "onlinequiz-bb97e",
                storageBucket: "onlinequiz-bb97e.firebasestorage.app",
                messagingSenderId: "1058944256488",
                appId: "1:1058944256488:web:504948b3c3311468dfbc5d"
            };

            /*
            –ü—Ä–∞–≤–∏–ª–∞ Firestore –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è —á—Ç–µ–Ω–∏—è –∏ –∑–∞–ø–∏—Å–∏:
            –ß—Ç–æ–±—ã –ø—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª—å Firebase:
            1. –û—Ç–∫—Ä–æ–π—Ç–µ https://console.firebase.google.com/
            2. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç "onlinequiz-bb97e"
            3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ "Firestore Database" -> "Rules"
            4. –í—Å—Ç–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ "Publish"

            rules_version = '2';
            service cloud.firestore {
              match /databases/{database}/documents {
                match /{document=**} {
                  allow read, write: if true;
                }
              }
            }
            */

            let app, db;

            try {
                if (!firebase.apps.length) {
                    app = firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore(app);
                    console.log('Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!');
                } else {
                    app = firebase.app();
                    db = firebase.firestore(app);
                    console.log('Firebase —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä.');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase:', {
                    message: error.message,
                    code: error.code,
                    stack: error.stack
                });
                showError('name-error', `–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase: ${error.message} (–∫–æ–¥: ${error.code})`);
                return;
            }

            // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            window.gameState = {
                playerId: generateId(),
                playerName: '',
                lobbyId: '',
                isHost: false,
                currentQuestion: 0,
                answers: [],
                questions: [],
                lobbyUnsubscribe: null,
                playersUnsubscribe: null
            };

            // –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
            const questionData = {
                flags: [
                    { question: "üá∫üá∏", options: ["–°–®–ê", "–ö–∞–Ω–∞–¥–∞", "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è", "–ê–≤—Å—Ç—Ä–∞–ª–∏—è"], answer: 0 },
                    { question: "üá´üá∑", options: ["–ò—Ç–∞–ª–∏—è", "–§—Ä–∞–Ω—Ü–∏—è", "–ò—Å–ø–∞–Ω–∏—è", "–ü–æ—Ä—Ç—É–≥–∞–ª–∏—è"], answer: 1 },
                    { question: "üá©üá™", options: ["–ê–≤—Å—Ç—Ä–∏—è", "–®–≤–µ–π—Ü–∞—Ä–∏—è", "–ì–µ—Ä–º–∞–Ω–∏—è", "–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã"], answer: 2 },
                    { question: "üáØüáµ", options: ["–ö–∏—Ç–∞–π", "–ö–æ—Ä–µ—è", "–Ø–ø–æ–Ω–∏—è", "–¢–∞–∏–ª–∞–Ω–¥"], answer: 2 },
                    { question: "üáßüá∑", options: ["–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞", "–ë—Ä–∞–∑–∏–ª–∏—è", "–ß–∏–ª–∏", "–ü–µ—Ä—É"], answer: 1 },
                    { question: "üáÆüáπ", options: ["–ì—Ä–µ—Ü–∏—è", "–ò—Å–ø–∞–Ω–∏—è", "–ò—Ç–∞–ª–∏—è", "–§—Ä–∞–Ω—Ü–∏—è"], answer: 2 },
                    { question: "üá®üá¶", options: ["–ö–∞–Ω–∞–¥–∞", "–°–®–ê", "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è", "–ê–≤—Å—Ç—Ä–∞–ª–∏—è"], answer: 0 },
                    { question: "üá¶üá∫", options: ["–ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è", "–ö–∞–Ω–∞–¥–∞", "–ê–≤—Å—Ç—Ä–∞–ª–∏—è", "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è"], answer: 2 },
                    { question: "üá®üá≥", options: ["–Ø–ø–æ–Ω–∏—è", "–ö–∏—Ç–∞–π", "–ö–æ—Ä–µ—è", "–ú–æ–Ω–≥–æ–ª–∏—è"], answer: 1 },
                    { question: "üá∑üá∫", options: ["–ü–æ–ª—å—à–∞", "–£–∫—Ä–∞–∏–Ω–∞", "–ë–µ–ª–∞—Ä—É—Å—å", "–†–æ—Å—Å–∏—è"], answer: 3 },
                    { question: "üá¨üáß", options: ["–ò—Ä–ª–∞–Ω–¥–∏—è", "–®–æ—Ç–ª–∞–Ω–¥–∏—è", "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è", "–£—ç–ª—å—Å"], answer: 2 },
                    { question: "üá™üá∏", options: ["–ü–æ—Ä—Ç—É–≥–∞–ª–∏—è", "–ò—Å–ø–∞–Ω–∏—è", "–ò—Ç–∞–ª–∏—è", "–§—Ä–∞–Ω—Ü–∏—è"], answer: 1 },
                    { question: "üá∞üá∑", options: ["–ö–∏—Ç–∞–π", "–Ø–ø–æ–Ω–∏—è", "–ö–æ—Ä–µ—è", "–¢–∞–∏–ª–∞–Ω–¥"], answer: 2 },
                    { question: "üáÆüá≥", options: ["–ü–∞–∫–∏—Å—Ç–∞–Ω", "–ò–Ω–¥–∏—è", "–ë–∞–Ω–≥–ª–∞–¥–µ—à", "–®—Ä–∏-–õ–∞–Ω–∫–∞"], answer: 1 },
                    { question: "üá≤üáΩ", options: ["–ú–µ–∫—Å–∏–∫–∞", "–ö–æ–ª—É–º–±–∏—è", "–í–µ–Ω–µ—Å—É—ç–ª–∞", "–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞"], answer: 0 }
                ],
                minecraft: [
                    { question: "–ò–∑ —á–µ–≥–æ –¥–µ–ª–∞–µ—Ç—Å—è –∫–∏—Ä–∫–∞?", options: ["–î–µ—Ä–µ–≤–æ –∏ –∫–∞–º–µ–Ω—å", "–ü–∞–ª–∫–∏ –∏ –º–∞—Ç–µ—Ä–∏–∞–ª", "–ñ–µ–ª–µ–∑–æ –∏ –∞–ª–º–∞–∑—ã", "–ó–æ–ª–æ—Ç–æ –∏ –∫–∞–º–µ–Ω—å"], answer: 1 },
                    { question: "–ß—Ç–æ –ø–∞–¥–∞–µ—Ç —Å –∫—Ä–∏–ø–µ—Ä–æ–≤?", options: ["–ü–æ—Ä–æ—Ö", "–ö–æ—Å—Ç–∏", "–ì–Ω–∏–ª–æ–µ –º—è—Å–æ", "–£–≥–æ–ª—å–Ω–∞—è –ø—ã–ª—å"], answer: 0 },
                    { question: "–°–∫–æ–ª—å–∫–æ –±–ª–æ–∫–æ–≤ –≤ —Å—Ç–∞–∫–µ?", options: ["32", "64", "128", "16"], answer: 1 },
                    { question: "–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ä—Ç–∞–ª–∞ –≤ –ù–∏–∂–Ω–∏–π –º–∏—Ä?", options: ["–ê–ª–º–∞–∑—ã", "–û–±—Å–∏–¥–∏–∞–Ω", "–ö–∞–º–µ–Ω—å", "–ñ–µ–ª–µ–∑–æ"], answer: 1 },
                    { question: "–ö–∞–∫–æ–π –º–æ–± –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–æ—á—å—é?", options: ["–°–≤–∏–Ω—å—è", "–ö–æ—Ä–æ–≤–∞", "–ó–æ–º–±–∏", "–û–≤—Ü–∞"], answer: 2 },
                    { question: "–ß—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –∏–∑ –ø—à–µ–Ω–∏—Ü—ã?", options: ["–•–ª–µ–±", "–¢–æ—Ä—Ç", "–ü–µ—á–µ–Ω—å–µ", "–ü–∏—Ä–æ–≥"], answer: 0 },
                    { question: "–°–∫–æ–ª—å–∫–æ —Å–µ—Ä–¥–µ—Ü –∑–¥–æ—Ä–æ–≤—å—è —É –∏–≥—Ä–æ–∫–∞?", options: ["5", "10", "15", "20"], answer: 1 },
                    { question: "–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–ª—è –∑–∞—á–∞—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤?", options: ["–ê–ª–º–∞–∑—ã", "–õ–∞–∑—É—Ä–∏—Ç", "–ó–æ–ª–æ—Ç–æ", "–ñ–µ–ª–µ–∑–æ"], answer: 1 },
                    { question: "–ö–∞–∫–æ–π –±–ª–æ–∫ —Å–≤–µ—Ç–∏—Ç—Å—è –≤ —Ç–µ–º–Ω–æ—Ç–µ?", options: ["–ö–∞–º–µ–Ω—å", "–§–∞–∫–µ–ª", "–î–µ—Ä–µ–≤–æ", "–ó–µ–º–ª—è"], answer: 1 },
                    { question: "–ß—Ç–æ –¥—Ä–æ–ø–∞–µ—Ç —ç–Ω–¥–µ—Ä–º–µ–Ω?", options: ["–ñ–µ–º—á—É–≥ –ö—Ä–∞—è", "–ü—ã–ª—å –∏—Ñ—Ä–∏—Ç–∞", "–°–ª–µ–∑–∞ –≥–∞—Å—Ç–∞", "–ü–∞—É—á–∏–π –≥–ª–∞–∑"], answer: 0 },
                    { question: "–°–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –¥–æ—Å–æ–∫ –¥–ª—è –≤–µ—Ä—Å—Ç–∞–∫–∞?", options: ["2", "4", "6", "8"], answer: 1 },
                    { question: "–ö–∞–∫–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω—É–∂–µ–Ω –¥–ª—è –¥–æ–±—ã—á–∏ –∫–∞–º–Ω—è?", options: ["–¢–æ–ø–æ—Ä", "–õ–æ–ø–∞—Ç–∞", "–ö–∏—Ä–∫–∞", "–ú–æ—Ç—ã–≥–∞"], answer: 2 },
                    { question: "–ß—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å –∏–∑ –∫–∞–∫–∞–æ-–±–æ–±–æ–≤?", options: ["–®–æ–∫–æ–ª–∞–¥", "–ü–µ—á–µ–Ω—å–µ", "–¢–æ—Ä—Ç", "–•–ª–µ–±"], answer: 1 },
                    { question: "–ö–∞–∫–æ–π –º–æ–± –¥—Ä–æ–ø–∞–µ—Ç –ø–µ—Ä—å—è?", options: ["–ö—É—Ä–∏—Ü–∞", "–°–≤–∏–Ω—å—è", "–ö–æ—Ä–æ–≤–∞", "–û–≤—Ü–∞"], answer: 0 },
                    { question: "–°–∫–æ–ª—å–∫–æ –±–ª–æ–∫–æ–≤ –≤—ã—Å–æ—Ç–æ–π –∏–≥—Ä–æ–∫?", options: ["1", "1.5", "2", "2.5"], answer: 2 }
                ]
            };

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ Firestore
            async function initializeQuestions() {
                try {
                    const flagsQuery = await db.collection('questions').where('theme', '==', 'flags').get();
                    
                    if (flagsQuery.empty) {
                        for (const q of questionData.flags) {
                            await db.collection('questions').add({
                                theme: 'flags',
                                question: q.question,
                                options: q.options,
                                answerIndex: q.answer
                            });
                        }
                    }

                    const minecraftQuery = await db.collection('questions').where('theme', '==', 'minecraft').get();
                    
                    if (minecraftQuery.empty) {
                        for (const q of questionData.minecraft) {
                            await db.collection('questions').add({
                                theme: 'minecraft',
                                question: q.question,
                                options: q.options,
                                answerIndex: q.answer
                            });
                        }
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:', error);
                }
            }

            initializeQuestions();

            // –£—Ç–∏–ª–∏—Ç—ã
            function generateId() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            function generateLobbyCode() {
                return Math.random().toString(36).substring(2, 8).toUpperCase();
            }

            function showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');
            }

            function showError(elementId, message) {
                const errorElement = document.getElementById(elementId);
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                setTimeout(() => {
                    errorElement.style.display = 'none';
                }, 5000);
            }

            // –ù–∞–≤–∏–≥–∞—Ü–∏—è –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏
            function showMainScreen() {
                if (gameState.lobbyUnsubscribe) gameState.lobbyUnsubscribe();
                if (gameState.playersUnsubscribe) gameState.playersUnsubscribe();
                gameState = {
                    playerId: generateId(),
                    playerName: '',
                    lobbyId: '',
                    isHost: false,
                    currentQuestion: 0,
                    answers: [],
                    questions: [],
                    lobbyUnsubscribe: null,
                    playersUnsubscribe: null
                };
                showScreen('main-screen');
            }

            function showCreateLobby() {
                const playerName = document.getElementById('player-name').value.trim();
                if (!playerName) {
                    showError('name-error', '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                    return;
                }
                gameState.playerName = playerName;
                showScreen('create-lobby-screen');
            }

            function showJoinLobby() {
                const playerName = document.getElementById('player-name').value.trim();
                if (!playerName) {
                    showError('name-error', '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                    return;
                }
                gameState.playerName = playerName;
                showScreen('join-lobby-screen');
            }

            // –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–±–±–∏
            async function createLobby() {
                try {
                    const theme = document.getElementById('theme-select').value;
                    const lobbyCode = generateLobbyCode();
                    
                    const questionsQuery = db.collection('questions').where('theme', '==', theme);
                    const questionsSnapshot = await questionsQuery.get();
                    const allQuestions = questionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    const selectedQuestions = allQuestions.sort(() => 0.5 - Math.random()).slice(0, 10);
                    
                    await db.collection('lobbies').doc(lobbyCode).set({
                        hostId: gameState.playerId,
                        status: 'waiting',
                        theme: theme,
                        currentQuestion: 0,
                        questions: selectedQuestions,
                        createdAt: new Date()
                    });

                    await db.collection('lobbies').doc(lobbyCode).collection('players').doc(gameState.playerId).set({
                        name: gameState.playerName,
                        score: 0,
                        answers: [],
                        joinedAt: new Date()
                    });

                    gameState.lobbyId = lobbyCode;
                    gameState.isHost = true;
                    
                    document.getElementById('current-lobby-code').textContent = lobbyCode;
                    document.getElementById('host-controls').style.display = 'block';
                    
                    setupLobbyListeners();
                    showScreen('lobby-screen');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ª–æ–±–±–∏:', error);
                    showError('create-error', '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ª–æ–±–±–∏');
                }
            }

            // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –ª–æ–±–±–∏
            async function joinLobby() {
                try {
                    const lobbyCode = document.getElementById('lobby-code-input').value.trim().toUpperCase();
                    if (!lobbyCode) {
                        showError('join-error', '–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ª–æ–±–±–∏');
                        return;
                    }

                    const lobbyDoc = await db.collection('lobbies').doc(lobbyCode).get();
                    
                    if (!lobbyDoc.exists) {
                        showError('join-error', '–õ–æ–±–±–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                        return;
                    }

                    const lobbyData = lobbyDoc.data();
                    if (lobbyData.status !== 'waiting') {
                        showError('join-error', '–ò–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å');
                        return;
                    }

                    await db.collection('lobbies').doc(lobbyCode).collection('players').doc(gameState.playerId).set({
                        name: gameState.playerName,
                        score: 0,
                        answers: [],
                        joinedAt: new Date()
                    });

                    gameState.lobbyId = lobbyCode;
                    gameState.isHost = false;
                    
                    document.getElementById('current-lobby-code').textContent = lobbyCode;
                    document.getElementById('host-controls').style.display = 'none';
                    
                    setupLobbyListeners();
                    showScreen('lobby-screen');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –ª–æ–±–±–∏:', error);
                    showError('join-error', '–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –ª–æ–±–±–∏');
                }
            }

            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π –ª–æ–±–±–∏
            function setupLobbyListeners() {
                gameState.lobbyUnsubscribe = db.collection('lobbies').doc(gameState.lobbyId).onSnapshot((doc) => {
                    if (doc.exists) {
                        const lobbyData = doc.data();
                        if (lobbyData.status === 'started') {
                            gameState.questions = lobbyData.questions;
                            startGameSession();
                        }
                    } else {
                        showError('lobby-error', '–õ–æ–±–±–∏ –±—ã–ª–æ —É–¥–∞–ª–µ–Ω–æ');
                        setTimeout(() => showMainScreen(), 2000);
                    }
                });

                gameState.playersUnsubscribe = db.collection('lobbies').doc(gameState.lobbyId).collection('players').onSnapshot((snapshot) => {
                    updatePlayersList(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
            }

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤
            function updatePlayersList(players) {
                const container = document.getElementById('players-container');
                container.innerHTML = '';
                
                players.forEach(player => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'player';
                    const isCurrentPlayer = player.id === gameState.playerId;
                    const isHost = gameState.isHost && isCurrentPlayer;
                    playerDiv.innerHTML = `
                        <span>${player.name} ${isCurrentPlayer ? '(–í—ã)' : ''}</span>
                        <span>${isHost ? 'üëë' : ''}</span>
                    `;
                    container.appendChild(playerDiv);
                });

                if (gameState.isHost) {
                    const startBtn = document.getElementById('start-game-btn');
                    startBtn.disabled = players.length < 2;
                    startBtn.textContent = players.length < 2 ? '–û–∂–∏–¥–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤...' : '–ù–∞—á–∞—Ç—å –∏–≥—Ä—É';
                }
            }

            // –ü–æ–∫–∏–Ω—É—Ç—å –ª–æ–±–±–∏
            async function leaveLobby() {
                try {
                    if (gameState.isHost) {
                        await db.collection('lobbies').doc(gameState.lobbyId).delete();
                    } else {
                        await db.collection('lobbies').doc(gameState.lobbyId).collection('players').doc(gameState.playerId).delete();
                    }
                    showMainScreen();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –ª–æ–±–±–∏:', error);
                }
            }

            // –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
            async function startGame() {
                try {
                    await db.collection('lobbies').doc(gameState.lobbyId).update({
                        status: 'started'
                    });
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã:', error);
                    showError('lobby-error', '–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–≥—Ä—ã');
                }
            }

            // –ù–∞—á–∞—Ç—å –∏–≥—Ä–æ–≤—É—é —Å–µ—Å—Å–∏—é
            function startGameSession() {
                gameState.currentQuestion = 0;
                gameState.answers = [];
                showScreen('game-screen');
                displayQuestion();
            }

            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞
            function displayQuestion() {
                const question = gameState.questions[gameState.currentQuestion];
                const questionCounter = document.getElementById('question-counter');
                const questionFlag = document.getElementById('question-flag');
                const questionText = document.getElementById('question-text');
                const optionsContainer = document.getElementById('options-container');
                const progressBar = document.getElementById('progress-bar');

                questionCounter.textContent = `–í–æ–ø—Ä–æ—Å ${gameState.currentQuestion + 1} –∏–∑ ${gameState.questions.length}`;
                
                if (question.theme === 'flags') {
                    questionFlag.textContent = question.question;
                    questionFlag.style.display = 'block';
                    questionText.textContent = '–ö–∞–∫–∞—è —ç—Ç–æ —Å—Ç—Ä–∞–Ω–∞?';
                } else {
                    questionFlag.style.display = 'none';
                    questionText.textContent = question.question;
                }

                progressBar.style.width = `${((gameState.currentQuestion + 1) / gameState.questions.length) * 100}%`;

                optionsContainer.innerHTML = '';
                question.options.forEach((option, index) => {
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'option';
                    optionDiv.textContent = option;
                    optionDiv.onclick = () => selectOption(index);
                    optionsContainer.appendChild(optionDiv);
                });

                document.getElementById('next-question-btn').style.display = 'none';
                document.getElementById('finish-game-btn').style.display = 'none';
            }

            // –í—ã–±–æ—Ä –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞
            function selectOption(selectedIndex) {
                const options = document.querySelectorAll('.option');
                options.forEach((option, index) => {
                    option.classList.remove('selected');
                    if (index === selectedIndex) {
                        option.classList.add('selected');
                    }
                });

                gameState.answers[gameState.currentQuestion] = selectedIndex;

                if (gameState.currentQuestion < gameState.questions.length - 1) {
                    document.getElementById('next-question-btn').style.display = 'block';
                } else {
                    document.getElementById('finish-game-btn').style.display = 'block';
                }
            }

            // –°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å
            function nextQuestion() {
                gameState.currentQuestion++;
                displayQuestion();
            }

            // –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É
            async function finishGame() {
                try {
                    let score = 0;
                    gameState.answers.forEach((answer, index) => {
                        if (answer === gameState.questions[index].answerIndex) {
                            score++;
                        }
                    });

                    await db.collection('lobbies').doc(gameState.lobbyId).collection('players').doc(gameState.playerId).update({
                        score: score,
                        answers: gameState.answers,
                        finished: true
                    });

                    const playersSnapshot = await db.collection('lobbies').doc(gameState.lobbyId).collection('players').get();
                    const players = playersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const allFinished = players.every(player => player.finished);

                    if (allFinished && gameState.isHost) {
                        await db.collection('lobbies').doc(gameState.lobbyId).update({
                            status: 'finished'
                        });
                    }

                    showResults(players);
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã:', error);
                    showError('lobby-error', '–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã');
                }
            }

            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            function showResults(players) {
                const resultsContainer = document.getElementById('results-container');
                resultsContainer.innerHTML = '';

                const sortedPlayers = players.sort((a, b) => b.score - a.score);
                
                sortedPlayers.forEach((player, index) => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'result-item';
                    
                    let medal = '';
                    if (index === 0) medal = 'ü•á';
                    else if (index === 1) medal = 'ü•à';
                    else if (index === 2) medal = 'ü•â';
                    
                    resultDiv.innerHTML = `
                        <div>
                            <span class="medal">${medal}</span>
                            ${player.name} ${player.id === gameState.playerId ? '(–í—ã)' : ''}
                        </div>
                        <div>${player.score}/${gameState.questions.length}</div>
                    `;
                    
                    resultsContainer.appendChild(resultDiv);
                });
                
                showScreen('results-screen');
            }

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('create-lobby-btn').addEventListener('click', showCreateLobby);
            document.getElementById('join-lobby-btn').addEventListener('click', showJoinLobby);
            document.getElementById('create-lobby-submit-btn').addEventListener('click', createLobby);
            document.getElementById('back-to-main-btn').addEventListener('click', showMainScreen);
            document.getElementById('join-lobby-submit-btn').addEventListener('click', joinLobby);
            document.getElementById('back-to-main-from-join-btn').addEventListener('click', showMainScreen);
            document.getElementById('start-game-btn').addEventListener('click', startGame);
            document.getElementById('leave-lobby-btn').addEventListener('click', leaveLobby);
            document.getElementById('next-question-btn').addEventListener('click', nextQuestion);
            document.getElementById('finish-game-btn').addEventListener('click', finishGame);
            document.getElementById('new-game-btn').addEventListener('click', showMainScreen);

            document.getElementById('player-name').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    showCreateLobby();
                }
            });

            document.getElementById('lobby-code-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    joinLobby();
                }
            });

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            function setupResultsListener() {
                if (gameState.playersUnsubscribe) {
                    gameState.playersUnsubscribe();
                }
                
                gameState.playersUnsubscribe = db.collection('lobbies').doc(gameState.lobbyId).collection('players').onSnapshot((snapshot) => {
                    const players = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    const allFinished = players.every(player => player.finished);
                    
                    if (allFinished) {
                        showResults(players);
                    }
                });
            }

            window.addEventListener('beforeunload', () => {
                if (gameState.lobbyUnsubscribe) gameState.lobbyUnsubscribe();
                if (gameState.playersUnsubscribe) gameState.playersUnsubscribe();
            });

            console.log('üéØ –ö–≤–∏–∑-–∏–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');
        });
    </script>
</body>
</html>
