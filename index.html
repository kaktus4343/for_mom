<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rock Paper Scissors - Online</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #f0f0f0;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #333;
    }
    .game-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: center;
      max-width: 500px;
      width: 100%;
    }
    .choices {
      display: flex;
      gap: 10px;
      margin: 20px 0;
      justify-content: center;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: white;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #result, #status, #score, #game-id {
      font-size: 18px;
      margin: 10px 0;
      color: #333;
    }
    #game-id-input {
      padding: 8px;
      font-size: 16px;
      margin: 10px;
      width: 200px;
    }
  </style>
</head>
<body>
  <h1>Rock Paper Scissors - Play Online</h1>
  <div class="game-container">
    <div id="setup">
      <input id="game-id-input" type="text" placeholder="Enter Game ID or leave blank">
      <button onclick="joinGame()">Join/Create Game</button>
    </div>
    <div id="game" style="display: none;">
      <div id="game-id"></div>
      <div id="status">Waiting for opponent...</div>
      <div class="choices">
        <button onclick="makeChoice('rock')" disabled>Rock</button>
        <button onclick="makeChoice('paper')" disabled>Paper</button>
        <button onclick="makeChoice('scissors')" disabled>Scissors</button>
      </div>
      <div id="result"></div>
      <div id="score">Wins: 0 | Losses: 0 | Ties: 0</div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js';
    import { getDatabase, ref, set, onValue, push, get, update, remove } from 'https://www.gstatic.com/firebasejs/10.13.2/firebase-database.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyApVIOCh2a6v6cLfCtLTcqrJALXv6Kjgmc",
      authDomain: "rockpaper-ec5ca.firebaseapp.com",
      databaseURL: "https://rockpaper-ec5ca-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "rockpaper-ec5ca",
      storageBucket: "rockpaper-ec5ca.firebasestorage.app",
      messagingSenderId: "228487151814",
      appId: "1:228487151814:web:54ddfa0f87b0b502ba57c7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let playerId = Math.random().toString(36).substring(2, 8);
    let gameId = null;
    let score = { wins: 0, losses: 0, ties: 0 };
    let playerNumber = null;

    function generateGameId() {
      return Math.random().toString(36).substring(2, 8);
    }

    async function joinGame() {
      const gameIdInput = document.getElementById('game-id-input').value.trim();
      gameId = gameIdInput || generateGameId();
      const gameRef = ref(db, `games/${gameId}`);

      try {
        const snapshot = await get(gameRef);
        if (!snapshot.exists()) {
          // Create new game
          await set(gameRef, {
            player1: { id: playerId, choice: null },
            player2: null,
            status: 'waiting',
            result: null
          });
          playerNumber = 1;
        } else {
          const gameData = snapshot.val();
          if (!gameData.player2) {
            // Join as player 2
            await update(gameRef, {
              player2: { id: playerId, choice: null },
              status: 'ready'
            });
            playerNumber = 2;
          } else {
            alert('Game is full!');
            return;
          }
        }

        document.getElementById('setup').style.display = 'none';
        document.getElementById('game').style.display = 'block';
        document.getElementById('game-id').textContent = `Game ID: ${gameId}`;
        listenToGameState();
      } catch (error) {
        console.error('Error joining game:', error);
        alert('Error joining game. Try again.');
      }
    }

    function enableChoices(enable) {
      const buttons = document.querySelectorAll('.choices button');
      buttons.forEach(button => button.disabled = !enable);
    }

    async function makeChoice(choice) {
      if (!gameId || !playerNumber) return;
      const gameRef = ref(db, `games/${gameId}`);
      const playerKey = `player${playerNumber}`;
      try {
        await update(gameRef, {
          [`${playerKey}/choice`]: choice
        });
        enableChoices(false);
      } catch (error) {
        console.error('Error making choice:', error);
      }
    }

    function determineWinner(player1Choice, player2Choice) {
      if (player1Choice === player2Choice) return 'tie';
      if (
        (player1Choice === 'rock' && player2Choice === 'scissors') ||
        (player1Choice === 'paper' && player2Choice === 'rock') ||
        (player1Choice === 'scissors' && player2Choice === 'paper')
      ) {
        return playerNumber === 1 ? 'win' : 'lose';
      }
      return playerNumber === 1 ? 'lose' : 'win';
    }

    async function resetGame(gameRef) {
      try {
        await update(gameRef, {
          'player1/choice': null,
          'player2/choice': null,
          result: null,
          status: 'ready'
        });
        enableChoices(true);
      } catch (error) {
        console.error('Error resetting game:', error);
      }
    }

    function listenToGameState() {
      const gameRef = ref(db, `games/${gameId}`);
      onValue(gameRef, async (snapshot) => {
        const gameData = snapshot.val();
        if (!gameData) {
          document.getElementById('status').textContent = 'Game not found.';
          document.getElementById('game').style.display = 'none';
          document.getElementById('setup').style.display = 'block';
          return;
        }

        // Update status
        if (gameData.status === 'waiting') {
          document.getElementById('status').textContent = 'Waiting for opponent...';
          enableChoices(false);
        } else if (gameData.status === 'ready') {
          document.getElementById('status').textContent = 'Both players ready! Make your choice.';
          enableChoices(true);
        }

        // Check if both players have made choices
        if (gameData.player1?.choice && gameData.player2?.choice) {
          const opponentChoice = playerNumber === 1 ? gameData.player2.choice : gameData.player1.choice;
          const myChoice = playerNumber === 1 ? gameData.player1.choice : gameData.player2.choice;
          const outcome = determineWinner(gameData.player1.choice, gameData.player2.choice);

          let resultText = '';
          if (outcome === 'tie') {
            resultText = `Tie! Both chose ${myChoice}.`;
            score.ties++;
          } else if (outcome === 'win') {
            resultText = `You win! Your ${myChoice} beats ${opponentChoice}.`;
            score.wins++;
          } else {
            resultText = `You lose! ${opponentChoice} beats your ${myChoice}.`;
            score.losses++;
          }

          document.getElementById('result').textContent = resultText;
          document.getElementById('score').textContent = `Wins: ${score.wins} | Losses: ${score.losses} | Ties: ${score.ties}`;

          // Save result to Firebase
          const gameResult = {
            gameId,
            player1Choice: gameData.player1.choice,
            player2Choice: gameData.player2.choice,
            winner: outcome === 'tie' ? 'tie' : (outcome === 'win' ? `player${playerNumber}` : `player${3 - playerNumber}`),
            timestamp: Date.now()
          };
          await push(ref(db, 'gameResults'), gameResult);

          // Reset game after a delay
          setTimeout(() => resetGame(gameRef), 2000);
        }
      }, (error) => {
        console.error('Error listening to game state:', error);
        document.getElementById('status').textContent = 'Error connecting to game.';
      });
    }

    // Clean up on page unload
    window.addEventListener('beforeunload', async () => {
      if (gameId && playerNumber) {
        const gameRef = ref(db, `games/${gameId}`);
        try {
          if (playerNumber === 1) {
            await remove(gameRef);
          } else {
            await update(gameRef, {
              player2: null,
              status: 'waiting',
              'player1/choice': null,
              'player2/choice': null,
              result: null
            });
          }
        } catch (error) {
          console.error('Error cleaning up:', error);
        }
      }
    });
  </script>
</body>
</html>
