<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Крестики-нолики Онлайн</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f0f0f0;
      padding: 20px;
    }
    #game {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      gap: 5px;
      justify-content: center;
      margin-top: 20px;
    }
    .cell {
      width: 100px;
      height: 100px;
      font-size: 2em;
      background: white;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .cell.taken {
      pointer-events: none;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-database-compat.js"></script>
</head>
<body>
  <h1>Крестики-нолики Онлайн</h1>
  <div id="game"></div>
  <p id="status">Загрузка...</p>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyADcCmBpiQNmhDrU2WCYCrB3CAE2DIqv6g",
      authDomain: "tic-tac-toe-online-2b731.firebaseapp.com",
      databaseURL: "https://tic-tac-toe-online-2b731-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tic-tac-toe-online-2b731",
      storageBucket: "tic-tac-toe-online-2b731.firebasestorage.app",
      messagingSenderId: "228936139438",
      appId: "1:228936139438:web:d065d36ffbb4c2d6e9e33f"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const gameDiv = document.getElementById("game");
    const statusText = document.getElementById("status");
    let playerSymbol = "";
    let gameId = prompt("Введите ID комнаты (оставь пустым для создания):");

    const cells = [];

    for (let i = 0; i < 9; i++) {
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.dataset.index = i;
      cell.addEventListener("click", () => makeMove(i));
      gameDiv.appendChild(cell);
      cells.push(cell);
    }

    function updateBoard(board) {
      board.forEach((val, i) => {
        cells[i].textContent = val;
        if (val !== "") cells[i].classList.add("taken");
      });
    }

    function makeMove(index) {
      db.ref("games/" + gameId).once("value", (snapshot) => {
        const data = snapshot.val();
        if (!data || data.board[index] !== "" || data.turn !== playerSymbol || data.winner) return;
        data.board[index] = playerSymbol;
        const winner = checkWin(data.board);
        db.ref("games/" + gameId).update({
          board: data.board,
          turn: playerSymbol === "X" ? "O" : "X",
          winner: winner
        });
      });
    }

    function checkWin(board) {
      const wins = [
        [0,1,2], [3,4,5], [6,7,8],
        [0,3,6], [1,4,7], [2,5,8],
        [0,4,8], [2,4,6]
      ];
      for (let [a,b,c] of wins) {
        if (board[a] && board[a] === board[b] && board[a] === board[c]) return board[a];
      }
      if (board.every(cell => cell !== "")) return "Ничья";
      return null;
    }

    function watchGame() {
      db.ref("games/" + gameId).on("value", (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        updateBoard(data.board);
        if (data.winner) {
          statusText.textContent = data.winner === "Ничья" ? "Ничья!" : `Победил: ${data.winner}`;
          gameDiv.querySelectorAll(".cell").forEach(cell => cell.classList.add("taken"));
        } else {
          statusText.textContent = data.turn === playerSymbol ? "Ваш ход" : "Ход соперника";
        }
      });
    }

    if (!gameId) {
      gameId = Math.random().toString(36).substring(2, 8);
      alert("Создана комната: " + gameId);
      playerSymbol = "X";
      db.ref("games/" + gameId).set({
        board: Array(9).fill(""),
        turn: "X",
        players: 1
      });
      statusText.textContent = "Ожидание второго игрока...";
      watchGame();
    } else {
      db.ref("games/" + gameId).once("value", snapshot => {
        const data = snapshot.val();
        if (data && data.players === 1) {
          db.ref("games/" + gameId + "/players").set(2);
          playerSymbol = "O";
          statusText.textContent = "Вы играете за O";
          watchGame();
        } else if (!data) {
          alert("Комната не найдена");
        } else {
          alert("Комната заполнена");
        }
      });
    }
  </script>
</body>
</html>
