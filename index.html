<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Онлайн Викторина</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .screen {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .active {
            display: block;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        input, select {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .players-list {
            margin: 20px 0;
        }
        
        .player {
            padding: 10px;
            margin: 5px 0;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        
        .question {
            font-size: 20px;
            margin: 20px 0;
        }
        
        .options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }
        
        .option {
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            cursor: pointer;
            text-align: center;
        }
        
        .option:hover {
            background-color: #e0e0e0;
        }
        
        .option.selected {
            background-color: #4CAF50;
            color: white;
        }
        
        .results {
            margin: 20px 0;
        }
        
        .result-item {
            padding: 10px;
            margin: 5px 0;
            background-color: #f0f0f0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        .first {
            background-color: gold;
        }
        
        .second {
            background-color: silver;
        }
        
        .third {
            background-color: #cd7f32; /* bronze */
        }
        
        .lobby-code {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            padding: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
        }
        
        .share-btn {
            background-color: #4285F4;
        }
        
        .share-btn:hover {
            background-color: #3367D6;
        }
        
        .flag-emoji {
            font-size: 50px;
            text-align: center;
            margin: 20px 0;
        }
        
        .progress {
            margin: 20px 0;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
        }
        
        .progress-bar {
            height: 100%;
            background-color: #4CAF50;
            border-radius: 5px;
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <h1>Онлайн Викторина</h1>
    
    <!-- Экран входа -->
    <div id="entry-screen" class="screen active">
        <h2>Добро пожаловать!</h2>
        <div>
            <label for="player-name">Ваше имя:</label>
            <input type="text" id="player-name" placeholder="Введите ваше имя" required>
        </div>
        
        <div>
            <label for="theme">Тема викторины:</label>
            <select id="theme">
                <option value="flags">Флаги стран</option>
                <option value="minecraft">Minecraft</option>
            </select>
        </div>
        
        <div style="margin-top: 20px;">
            <button id="create-lobby-btn">Создать лобби</button>
            <p>или</p>
            <div>
                <input type="text" id="lobby-code" placeholder="Введите код лобби">
                <button id="join-lobby-btn">Присоединиться</button>
            </div>
        </div>
    </div>
    
    <!-- Экран ожидания в лобби -->
    <div id="lobby-screen" class="screen">
        <h2>Лобби</h2>
        <div id="lobby-info">
            <p>Тема: <span id="lobby-theme"></span></p>
            <div class="lobby-code">Код лобби: <span id="lobby-code-display"></span></div>
            <button id="share-btn" class="share-btn">Поделиться</button>
        </div>
        
        <div class="players-list">
            <h3>Игроки:</h3>
            <div id="players-container"></div>
        </div>
        
        <div id="host-controls" style="display: none;">
            <button id="start-game-btn">Начать игру</button>
        </div>
    </div>
    
    <!-- Экран игры -->
    <div id="game-screen" class="screen">
        <div class="progress">
            <div class="progress-bar" id="progress-bar"></div>
        </div>
        <div class="question" id="question-text"></div>
        <div class="flag-emoji" id="flag-emoji" style="display: none;"></div>
        <div class="options" id="options-container"></div>
    </div>
    
    <!-- Экран результатов -->
    <div id="results-screen" class="screen">
        <h2>Результаты</h2>
        <div class="results" id="results-container"></div>
        <button id="return-to-lobby-btn">Вернуться в лобби</button>
    </div>
    
    <script>
        // Инициализация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAMBSvRY63cyjvQdbovfsSUws0r65iJ9vo",
            authDomain: "onlinequiz-bb97e.firebaseapp.com",
            databaseURL: "https://onlinequiz-bb97e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "onlinequiz-bb97e",
            storageBucket: "onlinequiz-bb97e.firebasestorage.app",
            messagingSenderId: "1058944256488",
            appId: "1:1058944256488:web:504948b3c3311468dfbc5d"
        };

        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const rtdb = firebase.database();

        // Глобальные переменные
        let playerName = '';
        let playerId = '';
        let lobbyId = '';
        let isHost = false;
        let currentTheme = '';
        let currentQuestionIndex = 0;
        let selectedAnswerIndex = null;
        let playerScore = 0;
        let questions = [];
        let playerAnswers = [];

        // Элементы интерфейса
        const screens = {
            entry: document.getElementById('entry-screen'),
            lobby: document.getElementById('lobby-screen'),
            game: document.getElementById('game-screen'),
            results: document.getElementById('results-screen')
        };

        // Функция для переключения экранов
        function showScreen(screenName) {
            for (const screen in screens) {
                screens[screen].classList.remove('active');
            }
            screens[screenName].classList.add('active');
        }

        // Генерация случайного ID
        function generateId(length = 6) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Создание лобби
        document.getElementById('create-lobby-btn').addEventListener('click', async () => {
            playerName = document.getElementById('player-name').value.trim();
            currentTheme = document.getElementById('theme').value;
            
            if (!playerName) {
                alert('Пожалуйста, введите ваше имя');
                return;
            }
            
            playerId = generateId(10);
            lobbyId = generateId(6);
            isHost = true;
            
            try {
                // Создаем лобби в Firestore
                await db.collection('lobbies').doc(lobbyId).set({
                    hostId: playerId,
                    status: 'waiting',
                    theme: currentTheme,
                    currentQuestion: 0,
                    questionIds: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Добавляем игрока в Realtime Database
                await rtdb.ref(`lobbies/${lobbyId}/players/${playerId}`).set({
                    name: playerName,
                    score: 0,
                    answers: []
                });
                
                // Показываем экран лобби
                showLobbyScreen();
                
                // Слушаем изменения в лобби
                setupLobbyListeners();
            } catch (error) {
                console.error('Ошибка при создании лобби:', error);
                alert('Не удалось создать лобби. Пожалуйста, попробуйте еще раз.');
            }
        });

        // Присоединение к лобби
        document.getElementById('join-lobby-btn').addEventListener('click', async () => {
            playerName = document.getElementById('player-name').value.trim();
            lobbyId = document.getElementById('lobby-code').value.trim().toUpperCase();
            
            if (!playerName) {
                alert('Пожалуйста, введите ваше имя');
                return;
            }
            
            if (!lobbyId || lobbyId.length !== 6) {
                alert('Пожалуйста, введите корректный код лобби (6 символов)');
                return;
            }
            
            playerId = generateId(10);
            isHost = false;
            
            try {
                // Проверяем существование лобби
                const lobbyDoc = await db.collection('lobbies').doc(lobbyId).get();
                
                if (!lobbyDoc.exists) {
                    alert('Лобби с таким кодом не найдено');
                    return;
                }
            
                const lobbyData = lobbyDoc.data();
                
                if (lobbyData.status !== 'waiting') {
                    alert('Игра уже началась или закончилась');
                    return;
                }
                
                currentTheme = lobbyData.theme;
                
                // Добавляем игрока в Realtime Database
                await rtdb.ref(`lobbies/${lobbyId}/players/${playerId}`).set({
                    name: playerName,
                    score: 0,
                    answers: []
                });
                
                // Показываем экран лобби
                showLobbyScreen();
                
                // Слушаем изменения в лобби
                setupLobbyListeners();
            } catch (error) {
                console.error('Ошибка при присоединении к лобби:', error);
                alert('Не удалось присоединиться к лобби. Пожалуйста, попробуйте еще раз.');
            }
        });

        // Показать экран лобби
        function showLobbyScreen() {
            document.getElementById('lobby-theme').textContent = 
                currentTheme === 'flags' ? 'Флаги стран' : 'Minecraft';
            document.getElementById('lobby-code-display').textContent = lobbyId;
            
            if (isHost) {
                document.getElementById('host-controls').style.display = 'block';
            } else {
                document.getElementById('host-controls').style.display = 'none';
            }
            
            showScreen('lobby');
        }

        // Настройка слушателей для лобби
        function setupLobbyListeners() {
            // Слушаем изменения в списке игроков
            rtdb.ref(`lobbies/${lobbyId}/players`).on('value', (snapshot) => {
                const players = snapshot.val() || {};
                updatePlayersList(players);
            });
            
            // Слушаем изменения состояния лобби
            db.collection('lobbies').doc(lobbyId).onSnapshot((doc) => {
                const lobbyData = doc.data();
                
                if (lobbyData.status === 'started') {
                    // Игра началась
                    if (lobbyData.questionIds.length > 0) {
                        questions = lobbyData.questionIds;
                        loadQuestionsAndStartGame();
                    }
                } else if (lobbyData.status === 'finished') {
                    // Игра закончилась
                    showResults();
                }
            });
            
            // Кнопка "Поделиться"
            document.getElementById('share-btn').addEventListener('click', () => {
                const url = `${window.location.origin}${window.location.pathname}?lobby=${lobbyId}`;
                if (navigator.share) {
                    navigator.share({
                        title: 'Присоединяйся к моей викторине!',
                        text: `Присоединяйся к моей викторине! Код лобби: ${lobbyId}`,
                        url: url
                    }).catch(err => {
                        console.log('Ошибка при попытке поделиться:', err);
                        copyToClipboard(lobbyId);
                    });
                } else {
                    copyToClipboard(lobbyId);
                }
            });
            
            // Кнопка "Начать игру" (только для хоста)
            document.getElementById('start-game-btn').addEventListener('click', async () => {
                try {
                    // Получаем 10 случайных вопросов по выбранной теме
                    const questionsQuery = await db.collection('questions')
                        .where('theme', '==', currentTheme)
                        .limit(10)
                        .get();
                    
                    const questionIds = questionsQuery.docs.map(doc => doc.id);
                    
                    // Обновляем лобби с ID вопросов и статусом "started"
                    await db.collection('lobbies').doc(lobbyId).update({
                        status: 'started',
                        questionIds: questionIds,
                        currentQuestion: 0
                    });
                } catch (error) {
                    console.error('Ошибка при начале игры:', error);
                    alert('Не удалось начать игру. Пожалуйста, попробуйте еще раз.');
                }
            });
            
            // Кнопка "Вернуться в лобби" на экране результатов
            document.getElementById('return-to-lobby-btn').addEventListener('click', () => {
                showLobbyScreen();
            });
        }

        // Обновление списка игроков
        function updatePlayersList(players) {
            const playersContainer = document.getElementById('players-container');
            playersContainer.innerHTML = '';
            
            Object.entries(players).forEach(([id, player]) => {
                const playerElement = document.createElement('div');
                playerElement.className = 'player';
                playerElement.textContent = player.name;
                
                if (id === playerId) {
                    playerElement.textContent += ' (Вы)';
                    playerElement.style.fontWeight = 'bold';
                }
                
                playersContainer.appendChild(playerElement);
            });
        }

        // Копирование в буфер обмена
        function copyToClipboard(text) {
            const input = document.createElement('input');
            input.value = text;
            document.body.appendChild(input);
            input.select();
            document.execCommand('copy');
            document.body.removeChild(input);
            alert(`Код лобби "${text}" скопирован в буфер обмена!`);
        }

        // Загрузка вопросов и начало игры
        async function loadQuestionsAndStartGame() {
            try {
                // Получаем вопросы из Firestore
                const questionsPromises = questions.map(questionId => 
                    db.collection('questions').doc(questionId).get()
                );
                
                const questionsSnapshots = await Promise.all(questionsPromises);
                questions = questionsSnapshots.map(snap => ({
                    id: snap.id,
                    ...snap.data()
                }));
                
                // Начинаем игру
                showScreen('game');
                showQuestion(0);
            } catch (error) {
                console.error('Ошибка при загрузке вопросов:', error);
                alert('Не удалось загрузить вопросы. Пожалуйста, попробуйте еще раз.');
            }
        }

        // Показать вопрос
        function showQuestion(index) {
            if (index >= questions.length) {
                // Все вопросы пройдены
                finishGame();
                return;
            }
            
            currentQuestionIndex = index;
            const question = questions[index];
            
            // Обновляем прогресс
            document.getElementById('progress-bar').style.width = `${(index / questions.length) * 100}%`;
            
            // Показываем вопрос
            document.getElementById('question-text').textContent = question.question;
            
            // Если тема "флаги", показываем эмодзи флага
            const flagEmoji = document.getElementById('flag-emoji');
            if (currentTheme === 'flags') {
                flagEmoji.textContent = question.question; // В этом случае question содержит эмодзи
                flagEmoji.style.display = 'block';
            } else {
                flagEmoji.style.display = 'none';
            }
            
            // Показываем варианты ответов
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, i) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.dataset.index = i;
                
                optionElement.addEventListener('click', () => {
                    // Убираем выделение у всех вариантов
                    document.querySelectorAll('.option').forEach(el => {
                        el.classList.remove('selected');
                    });
                    
                    // Выделяем выбранный вариант
                    optionElement.classList.add('selected');
                    selectedAnswerIndex = i;
                    
                    // Сохраняем ответ
                    saveAnswer(index, i);
                });
                
                optionsContainer.appendChild(optionElement);
            });
        }

        // Сохранение ответа
        async function saveAnswer(questionIndex, answerIndex) {
            playerAnswers[questionIndex] = answerIndex;
            
            // Проверяем правильность ответа
            const isCorrect = answerIndex === questions[questionIndex].answerIndex;
            if (isCorrect) {
                playerScore++;
            }
            
            // Обновляем данные игрока в Realtime Database
            await rtdb.ref(`lobbies/${lobbyId}/players/${playerId}`).update({
                answers: playerAnswers,
                score: playerScore
            });
            
            // Если хост, переходим к следующему вопросу через 3 секунды
            if (isHost) {
                setTimeout(async () => {
                    const nextIndex = questionIndex + 1;
                    
                    if (nextIndex < questions.length) {
                        // Обновляем текущий вопрос в лобби
                        await db.collection('lobbies').doc(lobbyId).update({
                            currentQuestion: nextIndex
                        });
                        
                        // Показываем следующий вопрос
                        showQuestion(nextIndex);
                    } else {
                        // Завершаем игру
                        await db.collection('lobbies').doc(lobbyId).update({
                            status: 'finished'
                        });
                    }
                }, 3000);
            }
        }

        // Завершение игры
        function finishGame() {
            showResults();
        }

        // Показать результаты
        async function showResults() {
            // Получаем всех игроков
            const playersSnapshot = await rtdb.ref(`lobbies/${lobbyId}/players`).once('value');
            const players = playersSnapshot.val() || {};
            
            // Преобразуем в массив и сортируем по очкам
            const playersArray = Object.entries(players).map(([id, player]) => ({
                id,
                ...player
            })).sort((a, b) => b.score - a.score);
            
            // Показываем результаты
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.innerHTML = '';
            
            playersArray.forEach((player, index) => {
                const resultElement = document.createElement('div');
                resultElement.className = 'result-item';
                
                if (index === 0) resultElement.classList.add('first');
                else if (index === 1) resultElement.classList.add('second');
                else if (index === 2) resultElement.classList.add('third');
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = player.id === playerId ? `${player.name} (Вы)` : player.name;
                
                const scoreSpan = document.createElement('span');
                scoreSpan.textContent = `${player.score}/${questions.length}`;
                
                resultElement.appendChild(nameSpan);
                resultElement.appendChild(scoreSpan);
                resultsContainer.appendChild(resultElement);
            });
            
            showScreen('results');
        }

        // Проверяем параметры URL для автоматического присоединения
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const lobbyParam = urlParams.get('lobby');
            
            if (lobbyParam) {
                document.getElementById('lobby-code').value = lobbyParam;
            }
        });
    </script>
</body>
</html>
