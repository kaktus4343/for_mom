<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Quiz Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/10.7.0/firebase-firestore-compat.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            font-size: 2em;
        }

        h2 {
            color: #555;
            margin-bottom: 20px;
        }

        input, select, button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .lobby-code {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .players-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .player-item {
            padding: 10px;
            margin: 5px 0;
            background: white;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .host-badge {
            background: #ffd700;
            color: #333;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .question-container {
            text-align: left;
        }

        .question-number {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 18px;
            margin-bottom: 20px;
            color: #333;
        }

        .flag-emoji {
            font-size: 60px;
            margin: 20px 0;
            display: block;
            text-align: center;
        }

        .option {
            background: #f8f9fa;
            border: 2px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option:hover {
            background: #e9ecef;
            border-color: #667eea;
        }

        .option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .results-table th,
        .results-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .results-table th {
            background: #667eea;
            color: white;
        }

        .place-badge {
            padding: 5px 10px;
            border-radius: 15px;
            font-weight: bold;
            color: white;
        }

        .place-1 { background: #ffd700; color: #333; }
        .place-2 { background: #c0c0c0; color: #333; }
        .place-3 { background: #cd7f32; color: white; }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            color: #e74c3c;
            background: #fadbd8;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω -->
        <div id="main-screen" class="screen active">
            <h1>üéØ Online Quiz</h1>
            <input type="text" id="player-name" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è" maxlength="20">
            <button onclick="showCreateLobby()">–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</button>
            <button onclick="showJoinLobby()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ª–æ–±–±–∏</button>
        </div>

        <!-- –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–±–±–∏ -->
        <div id="create-lobby-screen" class="screen">
            <h2>–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</h2>
            <select id="theme-select">
                <option value="flags">üè≥Ô∏è –§–ª–∞–≥–∏ —Å—Ç—Ä–∞–Ω</option>
                <option value="minecraft">‚õèÔ∏è Minecraft</option>
            </select>
            <button onclick="createLobby()">–°–æ–∑–¥–∞—Ç—å</button>
            <button onclick="showMainScreen()">–ù–∞–∑–∞–¥</button>
        </div>

        <!-- –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –ª–æ–±–±–∏ -->
        <div id="join-lobby-screen" class="screen">
            <h2>–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –ª–æ–±–±–∏</h2>
            <input type="text" id="lobby-code-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ª–æ–±–±–∏" maxlength="6">
            <button onclick="joinLobby()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
            <button onclick="showMainScreen()">–ù–∞–∑–∞–¥</button>
        </div>

        <!-- –õ–æ–±–±–∏ -->
        <div id="lobby-screen" class="screen">
            <h2>–õ–æ–±–±–∏</h2>
            <div class="lobby-code" id="lobby-code-display"></div>
            <div class="players-list">
                <h3>–ò–≥—Ä–æ–∫–∏:</h3>
                <div id="players-container"></div>
            </div>
            <button id="start-game-btn" onclick="startGame()" style="display: none;">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
            <button onclick="leaveLobby()">–ü–æ–∫–∏–Ω—É—Ç—å –ª–æ–±–±–∏</button>
        </div>

        <!-- –ò–≥—Ä–∞ -->
        <div id="game-screen" class="screen">
            <div class="question-container">
                <div class="question-number" id="question-number"></div>
                <div class="question-text" id="question-text"></div>
                <div id="flag-display"></div>
                <div id="options-container"></div>
                <button id="next-question-btn" onclick="nextQuestion()" style="display: none;">–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å</button>
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
        <div id="results-screen" class="screen">
            <h2>üèÜ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
            <table class="results-table">
                <thead>
                    <tr>
                        <th>–ú–µ—Å—Ç–æ</th>
                        <th>–ò–≥—Ä–æ–∫</th>
                        <th>–û—á–∫–∏</th>
                    </tr>
                </thead>
                <tbody id="results-table-body"></tbody>
            </table>
            <button onclick="backToMain()">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
        </div>

        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div id="loading-screen" class="screen">
            <div class="loading">
                <div class="spinner"></div>
            </div>
            <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>

        <!-- –û—à–∏–±–∫–∏ -->
        <div id="error-message" class="error" style="display: none;"></div>
    </div>

    <script>
        // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const firebaseConfig = {
            apiKey: "AIzaSyAMBSvRY63cyjvQdbovfsSUws0r65iJ9vo",
            authDomain: "onlinequiz-bb97e.firebaseapp.com",
            databaseURL: "https://onlinequiz-bb97e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "onlinequiz-bb97e",
            storageBucket: "onlinequiz-bb97e.firebasestorage.app",
            messagingSenderId: "1058944256488",
            appId: "1:1058944256488:web:504948b3c3311468dfbc5d"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentPlayerId = null;
        let currentLobbyId = null;
        let isHost = false;
        let currentQuestionIndex = 0;
        let questions = [];
        let selectedAnswer = null;
        let playerAnswers = [];
        let lobbyListener = null;
        let playersListener = null;

        // –í–æ–ø—Ä–æ—Å—ã –¥–ª—è –≤–∏–∫—Ç–æ—Ä–∏–Ω—ã
        const questionsData = {
            flags: [
                { question: "–ö–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ–ª–∞–≥?", flag: "üá∫üá∏", options: ["–°–®–ê", "–ö–∞–Ω–∞–¥–∞", "–ê–≤—Å—Ç—Ä–∞–ª–∏—è", "–ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è"], answerIndex: 0 },
                { question: "–ö–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ–ª–∞–≥?", flag: "üáØüáµ", options: ["–ö–∏—Ç–∞–π", "–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è", "–Ø–ø–æ–Ω–∏—è", "–¢–∞–π–ª–∞–Ω–¥"], answerIndex: 2 },
                { question: "–ö–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ–ª–∞–≥?", flag: "üá´üá∑", options: ["–ò—Ç–∞–ª–∏—è", "–§—Ä–∞–Ω—Ü–∏—è", "–ë–µ–ª—å–≥–∏—è", "–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã"], answerIndex: 1 },
                { question: "–ö–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ–ª–∞–≥?", flag: "üá¨üáß", options: ["–ò—Ä–ª–∞–Ω–¥–∏—è", "–®–æ—Ç–ª–∞–Ω–¥–∏—è", "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è", "–£—ç–ª—å—Å"], answerIndex: 2 },
                { question: "–ö–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ–ª–∞–≥?", flag: "üá©üá™", options: ["–ê–≤—Å—Ç—Ä–∏—è", "–®–≤–µ–π—Ü–∞—Ä–∏—è", "–ë–µ–ª—å–≥–∏—è", "–ì–µ—Ä–º–∞–Ω–∏—è"], answerIndex: 3 },
                { question: "–ö–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ–ª–∞–≥?", flag: "üáßüá∑", options: ["–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞", "–ë—Ä–∞–∑–∏–ª–∏—è", "–ö–æ–ª—É–º–±–∏—è", "–ü–µ—Ä—É"], answerIndex: 1 },
                { question: "–ö–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ–ª–∞–≥?", flag: "üá®üá¶", options: ["–ö–∞–Ω–∞–¥–∞", "–°–®–ê", "–ê–≤—Å—Ç—Ä–∞–ª–∏—è", "–ù–æ—Ä–≤–µ–≥–∏—è"], answerIndex: 0 },
                { question: "–ö–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ–ª–∞–≥?", flag: "üá¶üá∫", options: ["–ù–æ–≤–∞—è –ó–µ–ª–∞–Ω–¥–∏—è", "–í–µ–ª–∏–∫–æ–±—Ä–∏—Ç–∞–Ω–∏—è", "–ê–≤—Å—Ç—Ä–∞–ª–∏—è", "–§–∏–¥–∂–∏"], answerIndex: 2 },
                { question: "–ö–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ–ª–∞–≥?", flag: "üáÆüá≥", options: ["–ü–∞–∫–∏—Å—Ç–∞–Ω", "–ë–∞–Ω–≥–ª–∞–¥–µ—à", "–®—Ä–∏-–õ–∞–Ω–∫–∞", "–ò–Ω–¥–∏—è"], answerIndex: 3 },
                { question: "–ö–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ–ª–∞–≥?", flag: "üá®üá≥", options: ["–ö–∏—Ç–∞–π", "–Ø–ø–æ–Ω–∏—è", "–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è", "–°–µ–≤–µ—Ä–Ω–∞—è –ö–æ—Ä–µ—è"], answerIndex: 0 },
                { question: "–ö–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ–ª–∞–≥?", flag: "üá∑üá∫", options: ["–ë–µ–ª–∞—Ä—É—Å—å", "–£–∫—Ä–∞–∏–Ω–∞", "–†–æ—Å—Å–∏—è", "–ü–æ–ª—å—à–∞"], answerIndex: 2 },
                { question: "–ö–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ–ª–∞–≥?", flag: "üáÆüáπ", options: ["–§—Ä–∞–Ω—Ü–∏—è", "–ò—Å–ø–∞–Ω–∏—è", "–ü–æ—Ä—Ç—É–≥–∞–ª–∏—è", "–ò—Ç–∞–ª–∏—è"], answerIndex: 3 },
                { question: "–ö–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ–ª–∞–≥?", flag: "üá™üá∏", options: ["–ü–æ—Ä—Ç—É–≥–∞–ª–∏—è", "–ò—Å–ø–∞–Ω–∏—è", "–ú–µ–∫—Å–∏–∫–∞", "–ê—Ä–≥–µ–Ω—Ç–∏–Ω–∞"], answerIndex: 1 },
                { question: "–ö–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ–ª–∞–≥?", flag: "üá≥üá±", options: ["–ë–µ–ª—å–≥–∏—è", "–õ—é–∫—Å–µ–º–±—É—Ä–≥", "–ù–∏–¥–µ—Ä–ª–∞–Ω–¥—ã", "–î–∞–Ω–∏—è"], answerIndex: 2 },
                { question: "–ö–∞–∫–æ–π —Å—Ç—Ä–∞–Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç —ç—Ç–æ—Ç —Ñ–ª–∞–≥?", flag: "üá∏üá™", options: ["–ù–æ—Ä–≤–µ–≥–∏—è", "–î–∞–Ω–∏—è", "–§–∏–Ω–ª—è–Ω–¥–∏—è", "–®–≤–µ—Ü–∏—è"], answerIndex: 3 }
            ],
            minecraft: [
                { question: "–ò–∑ –∫–∞–∫–æ–≥–æ –º–∞—Ç–µ—Ä–∏–∞–ª–∞ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–∞–º—ã–µ –ø—Ä–æ—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã?", options: ["–ê–ª–º–∞–∑", "–ñ–µ–ª–µ–∑–æ", "–ó–æ–ª–æ—Ç–æ", "–ù–µ–∑–µ—Ä–∏—Ç"], answerIndex: 3 },
                { question: "–ö–∞–∫–æ–π –º–æ–± –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ù–µ–∑–µ—Ä–µ?", options: ["–ó–æ–º–±–∏", "–°–∫–µ–ª–µ—Ç", "–ì–∞—Å—Ç", "–ü–∞—É–∫"], answerIndex: 2 },
                { question: "–°–∫–æ–ª—å–∫–æ –±–ª–æ–∫–æ–≤ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –º–∏—Ä–∞ –≤ Minecraft?", options: ["256", "320", "384", "512"], answerIndex: 2 },
                { question: "–ö–∞–∫–æ–π –ø—Ä–µ–¥–º–µ—Ç –Ω—É–∂–µ–Ω –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ—Ä—Ç–∞–ª–∞ –≤ –ö—Ä–∞–π?", options: ["–ñ–µ–º—á—É–≥ –ö—Ä–∞—è", "–û–∫–æ –ö—Ä–∞—è", "–°—Ç–µ—Ä–∂–µ–Ω—å –∏—Ñ—Ä–∏—Ç–∞", "–ê–ª–º–∞–∑"], answerIndex: 1 },
                { question: "–ö–∞–∫–æ–π –º–æ–± —è–≤–ª—è–µ—Ç—Å—è –±–æ—Å—Å–æ–º –ö—Ä–∞—è?", options: ["–î—Ä–∞–∫–æ–Ω –ö—Ä–∞—è", "–ò—Å—Å—É—à–∏—Ç–µ–ª—å", "–°—Ç–∞—Ä—à–∏–π —Å—Ç—Ä–∞–∂", "–ü–æ–±–æ—Ä–Ω–∏–∫"], answerIndex: 0 },
                { question: "–ò–∑ —á–µ–≥–æ –º–æ–∂–Ω–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å —Ö–ª–µ–±?", options: ["–ö–∞—Ä—Ç–æ—Ñ–µ–ª—å", "–ú–æ—Ä–∫–æ–≤—å", "–ü—à–µ–Ω–∏—Ü–∞", "–°–≤–µ–∫–ª–∞"], answerIndex: 2 },
                { question: "–ö–∞–∫–æ–π –±–ª–æ–∫ –Ω—É–∂–µ–Ω –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ—Ä—Ç–∞–ª–∞ –≤ –ù–µ–∑–µ—Ä?", options: ["–û–±—Å–∏–¥–∏–∞–Ω", "–ë–µ–¥—Ä–æ–∫", "–ù–µ–∑–µ—Ä–∏—Ç", "–õ–∞–≤–∞"], answerIndex: 0 },
                { question: "–°–∫–æ–ª—å–∫–æ —Å–µ—Ä–¥–µ—Ü –∑–¥–æ—Ä–æ–≤—å—è —É –∏–≥—Ä–æ–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é?", options: ["5", "10", "15", "20"], answerIndex: 1 },
                { question: "–ö–∞–∫–æ–π –ø—Ä–µ–¥–º–µ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ—á–∏–Ω–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤?", options: ["–ê–ª–º–∞–∑", "–ñ–µ–ª–µ–∑–æ", "–ù–∞–∫–æ–≤–∞–ª—å–Ω—è", "–í–µ—Ä—Å—Ç–∞–∫"], answerIndex: 2 },
                { question: "–ö–∞–∫–æ–π –º–æ–± –≤–∑—Ä—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –∫ –∏–≥—Ä–æ–∫—É?", options: ["–ó–æ–º–±–∏", "–°–∫–µ–ª–µ—Ç", "–ö—Ä–∏–ø–µ—Ä", "–ü–∞—É–∫"], answerIndex: 2 },
                { question: "–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –µ—Å–ª–∏ –Ω–µ —Å–ø–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–æ—á–µ–π –ø–æ–¥—Ä—è–¥?", options: ["–ù–∏—á–µ–≥–æ", "–ü–æ—è–≤–ª—è—é—Ç—Å—è —Ñ–∞–Ω—Ç–æ–º—ã", "–£–º–µ–Ω—å—à–∞–µ—Ç—Å—è –∑–¥–æ—Ä–æ–≤—å–µ", "–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –≥–æ–ª–æ–¥"], answerIndex: 1 },
                { question: "–ö–∞–∫–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –Ω—É–∂–µ–Ω –¥–ª—è –¥–æ–±—ã—á–∏ –∫–∞–º–Ω—è?", options: ["–¢–æ–ø–æ—Ä", "–õ–æ–ø–∞—Ç–∞", "–ö–∏—Ä–∫–∞", "–ú–æ—Ç—ã–≥–∞"], answerIndex: 2 },
                { question: "–°–∫–æ–ª—å–∫–æ –±–ª–æ–∫–æ–≤ –≤ —Å—Ç–æ—Ä–æ–Ω–µ —É –æ–¥–Ω–æ–≥–æ —á–∞–Ω–∫–∞?", options: ["8", "16", "32", "64"], answerIndex: 1 },
                { question: "–ö–∞–∫–æ–π –º–∞—Ç–µ—Ä–∏–∞–ª –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ —Ç–æ–ª—å–∫–æ –≤ –ù–µ–∑–µ—Ä–µ?", options: ["–ê–ª–º–∞–∑", "–ó–æ–ª–æ—Ç–æ", "–ö–≤–∞—Ä—Ü –ù–µ–∑–µ—Ä–∞", "–ñ–µ–ª–µ–∑–æ"], answerIndex: 2 },
                { question: "–ö–∞–∫–æ–π —É—Ä–æ–≤–µ–Ω—å –æ—Å–≤–µ—â–µ–Ω–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∞–≤–Ω –º–æ–±–æ–≤?", options: ["7", "8", "9", "10"], answerIndex: 1 }
            ]
        };

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞–º–∏
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showMainScreen() {
            cleanup();
            showScreen('main-screen');
        }

        function showCreateLobby() {
            const playerName = document.getElementById('player-name').value.trim();
            if (!playerName) {
                showError('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }
            showScreen('create-lobby-screen');
        }

        function showJoinLobby() {
            const playerName = document.getElementById('player-name').value.trim();
            if (!playerName) {
                showError('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }
            showScreen('join-lobby-screen');
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ª–æ–±–±–∏
        async function createLobby() {
            const playerName = document.getElementById('player-name').value.trim();
            const theme = document.getElementById('theme-select').value;
            
            if (!playerName) {
                showError('–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
                return;
            }

            showScreen('loading-screen');

            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ Firestore
                await initializeQuestions();

                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –ª–æ–±–±–∏
                const lobbyCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                currentLobbyId = lobbyCode;
                currentPlayerId = generatePlayerId();
                isHost = true;

                // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤
                const randomQuestions = getRandomQuestions(theme, 10);

                // –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–±–±–∏
                await db.collection('lobbies').doc(lobbyCode).set({
                    hostId: currentPlayerId,
                    status: 'waiting',
                    theme: theme,
                    currentQuestion: 0,
                    questionIds: randomQuestions.map((_, index) => index.toString()),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ö–æ—Å—Ç–∞ –∫–∞–∫ –∏–≥—Ä–æ–∫–∞
                await db.collection('lobbies').doc(lobbyCode).collection('players').doc(currentPlayerId).set({
                    name: playerName,
                    score: 0,
                    answers: [],
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤ –¥–ª—è —ç—Ç–æ–π –∏–≥—Ä—ã
                questions = randomQuestions;

                setupLobbyListeners();
                document.getElementById('lobby-code-display').textContent = `–ö–æ–¥ –ª–æ–±–±–∏: ${lobbyCode}`;
                document.getElementById('start-game-btn').style.display = 'block';
                showScreen('lobby-screen');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ª–æ–±–±–∏:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ª–æ–±–±–∏');
                showMainScreen();
            }
        }

        async function joinLobby() {
            const playerName = document.getElementById('player-name').value.trim();
            const lobbyCode = document.getElementById('lobby-code-input').value.trim().toUpperCase();
            
            if (!playerName || !lobbyCode) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                return;
            }

            showScreen('loading-screen');

            try {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ª–æ–±–±–∏
                const lobbyDoc = await db.collection('lobbies').doc(lobbyCode).get();
                
                if (!lobbyDoc.exists) {
                    showError('–õ–æ–±–±–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                    showScreen('join-lobby-screen');
                    return;
                }

                const lobbyData = lobbyDoc.data();
                
                if (lobbyData.status !== 'waiting') {
                    showError('–ò–≥—Ä–∞ —É–∂–µ –Ω–∞—á–∞–ª–∞—Å—å');
                    showScreen('join-lobby-screen');
                    return;
                }

                currentLobbyId = lobbyCode;
                currentPlayerId = generatePlayerId();
                isHost = false;

                // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
                await db.collection('lobbies').doc(lobbyCode).collection('players').doc(currentPlayerId).set({
                    name: playerName,
                    score: 0,
                    answers: [],
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                setupLobbyListeners();
                document.getElementById('lobby-code-display').textContent = `–ö–æ–¥ –ª–æ–±–±–∏: ${lobbyCode}`;
                document.getElementById('start-game-btn').style.display = 'none';
                showScreen('lobby-screen');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –ª–æ–±–±–∏:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –ª–æ–±–±–∏');
                showScreen('join-lobby-screen');
            }
        }

        function setupLobbyListeners() {
            // –°–ª—É—à–∞—Ç–µ–ª—å –ª–æ–±–±–∏
            lobbyListener = db.collection('lobbies').doc(currentLobbyId).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    if (data.status === 'started') {
                        startGameForPlayer();
                    } else if (data.status === 'finished') {
                        showResults();
                    }
                }
            });

            // –°–ª—É—à–∞—Ç–µ–ª—å –∏–≥—Ä–æ–∫–æ–≤
            playersListener = db.collection('lobbies').doc(currentLobbyId).collection('players')
                .onSnapshot((snapshot) => {
                    updatePlayersList(snapshot);
                });
        }

        function updatePlayersList(snapshot) {
            const playersContainer = document.getElementById('players-container');
            playersContainer.innerHTML = '';

            snapshot.forEach((doc) => {
                const player = doc.data();
                const playerElement = document.createElement('div');
                playerElement.className = 'player-item';
                
                const isPlayerHost = doc.id === (isHost ? currentPlayerId : null);
                
                playerElement.innerHTML = `
                    <span>${player.name}</span>
                    ${isPlayerHost ? '<span class="host-badge">HOST</span>' : ''}
                `;
                
                playersContainer.appendChild(playerElement);
            });
        }

        async function startGame() {
            if (!isHost) return;

            try {
                await db.collection('lobbies').doc(currentLobbyId).update({
                    status: 'started',
                    currentQuestion: 0
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã:', error);
                showError('–û—à–∏–±–∫–∞ –Ω–∞—á–∞–ª–∞ –∏–≥—Ä—ã');
            }
        }

        async function startGameForPlayer() {
            currentQuestionIndex = 0;
            playerAnswers = [];
            selectedAnswer = null;

            // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–º—ã –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤
            const lobbyDoc = await db.collection('lobbies').doc(currentLobbyId).get();
            const lobbyData = lobbyDoc.data();
            const theme = lobbyData.theme;
            
            questions = getRandomQuestions(theme, 10);
            
            showScreen('game-screen');
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex >= questions.length) {
                finishGame();
                return;
            }

            const question = questions[currentQuestionIndex];
            
            document.getElementById('question-number').textContent = 
                `–í–æ–ø—Ä–æ—Å ${currentQuestionIndex + 1} –∏–∑ ${questions.length}`;
            
            document.getElementById('question-text').textContent = question.question;
            
            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ñ–ª–∞–≥–∞ –¥–ª—è —Ç–µ–º—ã —Ñ–ª–∞–≥–æ–≤
            const flagDisplay = document.getElementById('flag-display');
            if (question.flag) {
                flagDisplay.innerHTML = `<div class="flag-emoji">${question.flag}</div>`;
            } else {
                flagDisplay.innerHTML = '';
            }

            // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –æ—Ç–≤–µ—Ç–æ–≤
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionElement = document.createElement('div');
                optionElement.className = 'option';
                optionElement.textContent = option;
                optionElement.onclick = () => selectAnswer(index);
                optionsContainer.appendChild(optionElement);
            });

            selectedAnswer = null;
            document.getElementById('next-question-btn').style.display = 'none';
        }

        function selectAnswer(index) {
            selectedAnswer = index;
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
            document.querySelectorAll('.option').forEach((option, i) => {
                option.classList.toggle('selected', i === index);
            });
            
            document.getElementById('next-question-btn').style.display = 'block';
        }

        function nextQuestion() {
            if (selectedAnswer === null) return;
            
            playerAnswers.push(selectedAnswer);
            currentQuestionIndex++;
            displayQuestion();
        }

        async function finishGame() {
            // –ü–æ–¥—Å—á–µ—Ç –æ—á–∫–æ–≤
            let score = 0;
            for (let i = 0; i < playerAnswers.length; i++) {
                if (playerAnswers[i] === questions[i].answerIndex) {
                    score++;
                }
            }

            try {
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–≥—Ä–æ–∫–∞
                await db.collection('lobbies').doc(currentLobbyId).collection('players')
                    .doc(currentPlayerId).update({
                        score: score,
                        answers: playerAnswers
                    });

                // –ï—Å–ª–∏ —Ö–æ—Å—Ç, –∑–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É –¥–ª—è –≤—Å–µ—Ö
                if (isHost) {
                    setTimeout(async () => {
                        await db.collection('lobbies').doc(currentLobbyId).update({
                            status: 'finished'
                        });
                    }, 2000);
                }

                showResults();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∏–≥—Ä—ã');
            }
        }

        async function showResults() {
            try {
                const playersSnapshot = await db.collection('lobbies').doc(currentLobbyId)
                    .collection('players').get();
                
                const players = [];
                playersSnapshot.forEach((doc) => {
                    const player = doc.data();
                    players.push({
                        name: player.name,
                        score: player.score || 0
                    });
                });

                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –æ—á–∫–∞–º
                players.sort((a, b) => b.score - a.score);

                // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                const resultsTableBody = document.getElementById('results-table-body');
                resultsTableBody.innerHTML = '';

                players.forEach((player, index) => {
                    const row = document.createElement('tr');
                    const place = index + 1;
                    let placeBadge = '';
                    
                    if (place === 1) placeBadge = '<span class="place-badge place-1">ü•á</span>';
                    else if (place === 2) placeBadge = '<span class="place-badge place-2">ü•à</span>';
                    else if (place === 3) placeBadge = '<span class="place-badge place-3">ü•â</span>';
                    else placeBadge = `<span>${place}</span>`;

                    row.innerHTML = `
                        <td>${placeBadge}</td>
                        <td>${player.name}</td>
                        <td>${player.score}/10</td>
                    `;
                    
                    resultsTableBody.appendChild(row);
                });

                showScreen('results-screen');
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', error);
                showError('–û—à–∏–±–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤');
            }
        }
