<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Онлайн Квиз</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyADcCmBpiQNmhDrU2WCYCrB3CAE2DIqv6g",
      authDomain: "tic-tac-toe-online-2b731.firebaseapp.com",
      databaseURL: "https://tic-tac-toe-online-2b731-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tic-tac-toe-online-2b731",
      storageBucket: "tic-tac-toe-online-2b731.firebasestorage.app",
      messagingSenderId: "228936139438",
      appId: "1:228936139438:web:d065d36ffbb4c2d6e9e33f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let playerName = "";
    let playerId = "";
    let lobbyId = "";
    let isHost = false;
    let currentQuestionIndex = 0;
    let questions = [];

    const screens = {
      nameInput: document.getElementById("name-screen"),
      lobbyScreen: document.getElementById("lobby-screen"),
      gameScreen: document.getElementById("game-screen"),
      resultScreen: document.getElementById("result-screen")
    };

    function showScreen(screenId) {
      Object.values(screens).forEach(s => s.style.display = "none");
      screens[screenId].style.display = "block";
    }

    async function createLobby() {
      lobbyId = Math.random().toString(36).substr(2, 6);
      isHost = true;
      const theme = document.getElementById("theme").value;
      const qSnap = await getDocs(query(collection(db, "questions"), where("theme", "==", theme)));
      questions = shuffle([...qSnap.docs]).slice(0, 10).map(d => ({ id: d.id, ...d.data() }));
      await setDoc(doc(db, "lobbies", lobbyId), {
        hostId: playerId,
        status: "waiting",
        theme,
        currentQuestion: 0,
        questionIds: questions.map(q => q.id)
      });
      await setDoc(doc(db, `lobbies/${lobbyId}/players`, playerId), {
        name: playerName,
        score: 0,
        answers: []
      });
      listenLobby();
      showScreen("lobbyScreen");
    }

    async function joinLobby() {
      lobbyId = document.getElementById("join-code").value;
      const lobbyRef = doc(db, "lobbies", lobbyId);
      const lobbySnap = await getDoc(lobbyRef);
      if (!lobbySnap.exists()) return alert("Лобби не найдено");
      await setDoc(doc(db, `lobbies/${lobbyId}/players`, playerId), {
        name: playerName,
        score: 0,
        answers: []
      });
      listenLobby();
      showScreen("lobbyScreen");
    }

    function listenLobby() {
      const lobbyRef = doc(db, "lobbies", lobbyId);
      onSnapshot(lobbyRef, async (snap) => {
        const data = snap.data();
        if (data.status === "started") {
          const qSnap = await getDocs(collection(db, "questions"));
          questions = data.questionIds.map(id => qSnap.docs.find(q => q.id === id).data());
          showQuestion();
        } else if (data.status === "finished") {
          showResults();
        }
      });
      const playersRef = collection(db, `lobbies/${lobbyId}/players`);
      onSnapshot(playersRef, (snap) => {
        const container = document.getElementById("players");
        container.innerHTML = "";
        snap.forEach(doc => {
          const div = document.createElement("div");
          div.textContent = doc.data().name;
          container.appendChild(div);
        });
      });
    }

    function showQuestion() {
      showScreen("gameScreen");
      const q = questions[currentQuestionIndex];
      document.getElementById("question").textContent = q.question;
      const options = document.getElementById("options");
      options.innerHTML = "";
      q.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.onclick = () => submitAnswer(idx);
        options.appendChild(btn);
      });
    }

    async function submitAnswer(index) {
      const playerRef = doc(db, `lobbies/${lobbyId}/players`, playerId);
      const playerSnap = await getDoc(playerRef);
      const player = playerSnap.data();
      const correct = questions[currentQuestionIndex].answerIndex === index;
      await updateDoc(playerRef, {
        answers: [...player.answers, index],
        score: player.score + (correct ? 1 : 0)
      });
      currentQuestionIndex++;
      if (currentQuestionIndex < 10) showQuestion();
      else if (isHost) await updateDoc(doc(db, "lobbies", lobbyId), { status: "finished" });
    }

    async function showResults() {
      showScreen("resultScreen");
      const snap = await getDocs(collection(db, `lobbies/${lobbyId}/players`));
      const results = [];
      snap.forEach(doc => {
        const d = doc.data();
        results.push({ name: d.name, score: d.score });
      });
      results.sort((a, b) => b.score - a.score);
      const resBox = document.getElementById("results");
      resBox.innerHTML = results.map((r, i) => `${i + 1}. ${r.name} — ${r.score}`).join("<br>");
    }

    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    window.startGame = async () => {
      await updateDoc(doc(db, "lobbies", lobbyId), { status: "started" });
    };

    window.enterGame = () => {
      playerName = document.getElementById("name").value;
      playerId = Math.random().toString(36).substr(2, 9);
      showScreen("nameInput");
    };

    window.createLobby = createLobby;
    window.joinLobby = joinLobby;

  </script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #lobby-screen, #game-screen, #result-screen { display: none; }
    button { margin: 5px; padding: 10px; }
  </style>
</head>
<body onload="showScreen('nameInput')">
  <div id="name-screen">
    <input id="name" placeholder="Ваше имя" />
    <button onclick="showScreen('lobby-screen')">Продолжить</button>
  </div>
  <div id="lobby-screen">
    <select id="theme">
      <option value="flags">Флаги</option>
      <option value="minecraft">Minecraft</option>
    </select>
    <button onclick="createLobby()">Создать лобби</button>
    <input id="join-code" placeholder="Код лобби" />
    <button onclick="joinLobby()">Присоединиться</button>
    <div id="players"></div>
    <button onclick="startGame()">Начать игру</button>
  </div>
  <div id="game-screen">
    <div id="question"></div>
    <div id="options"></div>
  </div>
  <div id="result-screen">
    <h3>Результаты:</h3>
    <div id="results"></div>
  </div>
</body>
</html>
